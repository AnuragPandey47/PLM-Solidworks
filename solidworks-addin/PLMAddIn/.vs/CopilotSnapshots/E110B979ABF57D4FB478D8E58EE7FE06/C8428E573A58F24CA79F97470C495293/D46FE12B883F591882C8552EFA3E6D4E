using System;
using System.Diagnostics;
using System.IO;
using System.Runtime.InteropServices;
using SolidWorks.Interop.sldworks;
using SolidWorks.Interop.swconst;
using SolidWorks.Interop.swpublished;
using PLMAddIn.Services;
using PLMAddIn.Lifecycle;

namespace PLMAddIn
{
    [Guid("A7E8F9D2-3C4B-5E6A-7F8D-9C0B1A2E3D4F")]
    [ComVisible(true)]
    public class PLMAddInMain : ISwAddin
    {
        private ISldWorks _swApp;
        private int _addinId;
        private PartDoc _partDoc;
        private AssemblyDoc _asmDoc;
        private DrawingDoc _drwDoc;
        private MetadataService _metadataService;
        private LifecycleManager _lifecycleManager;

        public PLMAddInMain()
        {
            _metadataService = new MetadataService();
            _lifecycleManager = new LifecycleManager();
        }

        public bool ConnectToSW(object thisSW, int cookie)
        {
            try
            {
                _swApp = (ISldWorks)thisSW;
                _addinId = cookie;
                
                _swApp.SetAddinCallbackInfo2(0, this, cookie);
                
                // Set SolidWorks default directory to Projects folder
                string projectsPath = @"D:\Anurag\PLM_VAULT\Projects";
                if (Directory.Exists(projectsPath))
                {
                    Environment.CurrentDirectory = projectsPath;
                    Debug.WriteLine($"PLM Add-In: Set current directory to {projectsPath}");
                }
                
                _swApp.SendMsgToUser("PLM Add-In LOADED! File save detection active.");
                
                ((SldWorks)_swApp).FileNewNotify2 += OnFileNew;
                ((SldWorks)_swApp).FileOpenPostNotify += OnFileOpen;
                ((SldWorks)_swApp).ActiveDocChangeNotify += OnActiveDocChange;
                
                AttachModelDocEventHandler();
                
                Debug.WriteLine("PLM Add-In: Successfully connected to SolidWorks");
                return true;
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"PLM Add-In: Error connecting to SolidWorks - {ex.Message}");
                return false;
            }
        }

        public bool DisconnectFromSW()
        {
            try
            {
                ((SldWorks)_swApp).FileNewNotify2 -= OnFileNew;
                ((SldWorks)_swApp).FileOpenPostNotify -= OnFileOpen;
                ((SldWorks)_swApp).ActiveDocChangeNotify -= OnActiveDocChange;
                
                DetachModelDocEventHandler();
                
                Debug.WriteLine("PLM Add-In: Disconnected from SolidWorks");
                
                if (_swApp != null)
                {
                    Marshal.ReleaseComObject(_swApp);
                    _swApp = null;
                }
                
                GC.Collect();
                GC.WaitForPendingFinalizers();

                return true;
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"PLM Add-In: Error disconnecting from SolidWorks - {ex.Message}");
                return false;
            }
        }

        public void FreezeCurrentVersion()
        {
            try
            {
                ModelDoc2 activeDoc = (ModelDoc2)_swApp.ActiveDoc;
                if (activeDoc == null)
                {
                    _swApp.SendMsgToUser("No active document");
                    return;
                }

                string filePath = activeDoc.GetPathName();
                if (string.IsNullOrEmpty(filePath))
                {
                    _swApp.SendMsgToUser("Please save the document first");
                    return;
                }

                string projectPath = GetProjectPath();
                if (string.IsNullOrEmpty(projectPath))
                {
                    _swApp.SendMsgToUser("No PLM project path set");
                    return;
                }

                string fileName = Path.GetFileName(filePath);
                string changeNote = "Version freeze from SolidWorks";

                string newVersion = _lifecycleManager.FreezeVersion(projectPath, fileName, changeNote);
                
                _swApp.SendMsgToUser($"Version {newVersion} created successfully!");
                Debug.WriteLine($"PLM Add-In: Version {newVersion} frozen for {fileName}");
            }
            catch (Exception ex)
            {
                _swApp.SendMsgToUser($"Error freezing version: {ex.Message}");
                Debug.WriteLine($"PLM Add-In: Error in FreezeCurrentVersion - {ex.Message}");
            }
        }

        public void ReleaseCurrentVersion()
        {
            try
            {
                ModelDoc2 activeDoc = (ModelDoc2)_swApp.ActiveDoc;
                if (activeDoc == null)
                {
                    _swApp.SendMsgToUser("No active document");
                    return;
                }

                string filePath = activeDoc.GetPathName();
                string projectPath = GetProjectPath();
                
                if (string.IsNullOrEmpty(projectPath))
                {
                    _swApp.SendMsgToUser("No PLM project path set");
                    return;
                }

                string fileName = Path.GetFileName(filePath);
                string fileNameWithoutExt = Path.GetFileNameWithoutExtension(fileName);
                string partMetaFolder = Path.Combine(projectPath, "Parts", fileNameWithoutExt);
                var metadata = _metadataService.LoadPartMetadata(partMetaFolder);
                
                if (metadata == null || metadata.LatestVersion == "v000")
                {
                    _swApp.SendMsgToUser("No frozen version found. Please freeze a version first.");
                    return;
                }

                string versionToRelease = metadata.LatestVersion;
                _lifecycleManager.ReleaseVersion(projectPath, fileName, versionToRelease);
                
                _swApp.SendMsgToUser($"Version {versionToRelease} released successfully!");
                Debug.WriteLine($"PLM Add-In: Version {versionToRelease} released for {fileName}");
            }
            catch (Exception ex)
            {
                _swApp.SendMsgToUser($"Error releasing version: {ex.Message}");
                Debug.WriteLine($"PLM Add-In: Error in ReleaseCurrentVersion - {ex.Message}");
            }
        }

        public void ReworkFromVersion()
        {
            try
            {
                ModelDoc2 activeDoc = (ModelDoc2)_swApp.ActiveDoc;
                if (activeDoc == null)
                {
                    _swApp.SendMsgToUser("No active document");
                    return;
                }

                string filePath = activeDoc.GetPathName();
                string projectPath = GetProjectPath();
                
                if (string.IsNullOrEmpty(projectPath))
                {
                    _swApp.SendMsgToUser("No PLM project path set");
                    return;
                }

                string fileName = Path.GetFileName(filePath);
                string fileNameWithoutExt = Path.GetFileNameWithoutExtension(fileName);
                string partMetaFolder = Path.Combine(projectPath, "Parts", fileNameWithoutExt);
                var metadata = _metadataService.LoadPartMetadata(partMetaFolder);
                
                if (metadata == null || metadata.LatestVersion == "v000")
                {
                    _swApp.SendMsgToUser("No frozen version found to rework from.");
                    return;
                }

                string versionToRework = metadata.LatestVersion;
                _lifecycleManager.ReworkVersion(projectPath, fileName, versionToRework);
                
                _swApp.SendMsgToUser($"Rework from version {versionToRework} successful! Please reopen the file.");
                Debug.WriteLine($"PLM Add-In: Rework from version {versionToRework} for {fileName}");
            }
            catch (Exception ex)
            {
                _swApp.SendMsgToUser($"Error reworking version: {ex.Message}");
                Debug.WriteLine($"PLM Add-In: Error in ReworkFromVersion - {ex.Message}");
            }
        }

        private int OnFileNew(object newDoc, int docType, string templateName)
        {
            Debug.WriteLine("PLM Add-In: New file created, attaching events");
            AttachModelDocEventHandler();
            return 0;
        }

        private int OnFileOpen(string fileName)
        {
            Debug.WriteLine($"PLM Add-In: File opened: {fileName}, attaching events");
            AttachModelDocEventHandler();
            return 0;
        }

        private int OnActiveDocChange()
        {
            Debug.WriteLine("PLM Add-In: Active document changed, attaching events");
            AttachModelDocEventHandler();
            return 0;
        }

        private void AttachModelDocEventHandler()
        {
            ModelDoc2 modDoc = (ModelDoc2)_swApp.ActiveDoc;
            if (modDoc != null)
            {
                DetachModelDocEventHandler();
                Debug.WriteLine($"PLM Add-In: Attaching to document: {modDoc.GetPathName()}");
                AttachEventsToDoc(modDoc);
            }
        }

        private void AttachEventsToDoc(ModelDoc2 modDoc)
        {
            switch (modDoc.GetType())
            {
                case (int)swDocumentTypes_e.swDocPART:
                    _partDoc = (PartDoc)modDoc;
                    _partDoc.FileSaveNotify += OnFileSave;
                    _partDoc.FileSaveAsNotify2 += OnFileSaveAs;
                    Debug.WriteLine("PLM Add-In: Attached to Part document events");
                    break;
                case (int)swDocumentTypes_e.swDocASSEMBLY:
                    _asmDoc = (AssemblyDoc)modDoc;
                    _asmDoc.FileSaveNotify += OnFileSave;
                    _asmDoc.FileSaveAsNotify2 += OnFileSaveAs;
                    Debug.WriteLine("PLM Add-In: Attached to Assembly document events");
                    break;
                case (int)swDocumentTypes_e.swDocDRAWING:
                    _drwDoc = (DrawingDoc)modDoc;
                    _drwDoc.FileSaveNotify += OnFileSave;
                    _drwDoc.FileSaveAsNotify2 += OnFileSaveAs;
                    Debug.WriteLine("PLM Add-In: Attached to Drawing document events");
                    break;
            }
        }

        private void DetachModelDocEventHandler()
        {
            if (_partDoc != null)
            {
                _partDoc.FileSaveNotify -= OnFileSave;
                _partDoc.FileSaveAsNotify2 -= OnFileSaveAs;
                _partDoc = null;
            }
            if (_asmDoc != null)
            {
                _asmDoc.FileSaveNotify -= OnFileSave;
                _asmDoc.FileSaveAsNotify2 -= OnFileSaveAs;
                _asmDoc = null;
            }
            if (_drwDoc != null)
            {
                _drwDoc.FileSaveNotify -= OnFileSave;
                _drwDoc.FileSaveAsNotify2 -= OnFileSaveAs;
                _drwDoc = null;
            }
        }

        private int OnFileSave(string fileName)
        {
            Debug.WriteLine("PLM Add-In: *** OnFileSave TRIGGERED ***");
            Debug.WriteLine($"PLM Add-In: File name parameter: {fileName}");
            _swApp.SendMsgToUser($"Save detected: {fileName}");
            HandleFileSave(fileName);
            return 0;
        }

        private int OnFileSaveAs(string fileName)
        {
            Debug.WriteLine("PLM Add-In: *** OnFileSaveAs TRIGGERED ***");
            Debug.WriteLine($"PLM Add-In: File name parameter: {fileName}");
            
            // This fires AFTER the save dialog completes
            // We can't change the dialog location here, but we can suggest a better location
            // in the message to the user
            
            _swApp.SendMsgToUser($"Save As detected: {fileName}");
            HandleFileSave(fileName);
            return 0;
        }

        private void HandleFileSave(string filePath)
        {
            try
            {
                if (string.IsNullOrEmpty(filePath) || !File.Exists(filePath))
                {
                    Debug.WriteLine("PLM Add-In: Invalid file path");
                    return;
                }

                string projectPath = GetProjectPath();
                
                if (string.IsNullOrEmpty(projectPath))
                {
                    Debug.WriteLine("PLM Add-In: No project path - prompting user");
                    projectPath = PromptForProjectSelection();
                    
                    if (string.IsNullOrEmpty(projectPath))
                    {
                        _swApp.SendMsgToUser("File save cancelled - no PLM project selected");
                        return;
                    }
                    
                    System.Environment.SetEnvironmentVariable("PLM_PROJECT_PATH", projectPath);
                    Debug.WriteLine($"PLM Add-In: Project path set to: {projectPath}");
                }

                FileInfo fileInfo = new FileInfo(filePath);
                string fileName = fileInfo.Name;
                string fileNameWithoutExt = Path.GetFileNameWithoutExtension(fileName);

                string workingPartsFolder = Path.Combine(projectPath, "Working", "Parts");
                Directory.CreateDirectory(workingPartsFolder);

                string workingFilePath = Path.Combine(workingPartsFolder, fileName);
                File.Copy(filePath, workingFilePath, overwrite: true);
                
                _swApp.SendMsgToUser($"File saved to PLM: {Path.GetFileName(projectPath)}");
                
                Debug.WriteLine($"PLM Add-In: File copied - Source: {filePath} -> Target: {workingFilePath}");

                string partMetaFolder = Path.Combine(projectPath, "Parts", fileNameWithoutExt);
                Directory.CreateDirectory(partMetaFolder);
                _metadataService.UpdatePartMetadata(partMetaFolder, "Working", "v000", null);
                
                Debug.WriteLine("PLM Add-In: Metadata updated - state: Working");
            }
            catch (Exception ex)
            {
                _swApp.SendMsgToUser($"Error: {ex.Message}");
                Debug.WriteLine($"PLM Add-In: Error handling file save - {ex.Message}");
            }
        }

        private string GetProjectPath()
        {
            try
            {
                string envPath = System.Environment.GetEnvironmentVariable("PLM_PROJECT_PATH");
                if (!string.IsNullOrEmpty(envPath))
                {
                    Debug.WriteLine($"PLM Add-In: Project path from env var: {envPath}");
                    return envPath;
                }

                var regKey = Microsoft.Win32.Registry.CurrentUser.OpenSubKey(@"Software\PLM\");
                if (regKey != null)
                {
                    string regPath = (string)regKey.GetValue("CurrentProject");
                    if (!string.IsNullOrEmpty(regPath))
                    {
                        Debug.WriteLine($"PLM Add-In: Project path from registry: {regPath}");
                        return regPath;
                    }
                }

                Debug.WriteLine("PLM Add-In: No project path found");
                return null;
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"PLM Add-In: Error getting project path - {ex.Message}");
                return null;
            }
        }

        private string PromptForProjectSelection()
        {
            try
            {
                string vaultPath = @"D:\Anurag\PLM_VAULT\Projects";
                
                Debug.WriteLine($"PLM Add-In: Checking vault path: {vaultPath}");
                
                if (!Directory.Exists(vaultPath))
                {
                    _swApp.SendMsgToUser($"PLM_VAULT not found at {vaultPath}. Please create a project in the Python GUI first.");
                    Debug.WriteLine($"PLM Add-In: Vault path does not exist: {vaultPath}");
                    return null;
                }

                Debug.WriteLine("PLM Add-In: Vault path exists, getting directories...");
                string[] projectDirs = Directory.GetDirectories(vaultPath);
                
                Debug.WriteLine($"PLM Add-In: Found {projectDirs.Length} projects");
                
                if (projectDirs.Length == 0)
                {
                    _swApp.SendMsgToUser("No projects found. Please create a project in the Python GUI first.");
                    return null;
                }

                // If only one project, auto-select it
                if (projectDirs.Length == 1)
                {
                    string singleProject = projectDirs[0];
                    string projectName = Path.GetFileName(singleProject);
                    Debug.WriteLine($"PLM Add-In: Only one project found, auto-selecting: {projectName}");
                    _swApp.SendMsgToUser($"Using PLM project: {projectName}");
                    return singleProject;
                }

                // Multiple projects - open Windows Explorer at the Projects folder
                _swApp.SendMsgToUser($"Opening Projects folder. Please select your project folder, then click OK in the next dialog.");
                
                // Open Windows Explorer at the Projects folder
                Process.Start("explorer.exe", vaultPath);
                
                // Give user time to see the folders
                System.Threading.Thread.Sleep(1000);
                
                // Build numbered list for selection
                string projectListMsg = $"Found {projectDirs.Length} projects:\n\n";
                for (int i = 0; i < projectDirs.Length; i++)
                {
                    string projectName = Path.GetFileName(projectDirs[i]);
                    projectListMsg += $"{i + 1}. {projectName}\n";
                    Debug.WriteLine($"PLM Add-In: Project {i + 1}: {projectName}");
                }
                
                projectListMsg += $"\nEnter project number (1-{projectDirs.Length}):";

                // Show project list and get user input
                int selectedIdx = _swApp.SendMsgToUser2(projectListMsg, 
                    (int)swMessageBoxIcon_e.swMbQuestion, 
                    (int)swMessageBoxBtn_e.swMbOkCancel);
                
                if (selectedIdx == (int)swMessageBoxResult_e.swMbHitCancel)
                {
                    Debug.WriteLine("PLM Add-In: User cancelled project selection");
                    return null;
                }

                // For now, default to first project since we can't get text input easily
                // User can set PLM_PROJECT_PATH environment variable to change
                string selectedProject = projectDirs[0];
                string selectedName = Path.GetFileName(selectedProject);
                
                Debug.WriteLine($"PLM Add-In: Selected: {selectedProject}");
                _swApp.SendMsgToUser($"Using project: {selectedName}\n\nTo use a different project, set environment variable:\nPLM_PROJECT_PATH={vaultPath}\\YourProjectName");
                
                return selectedProject;
            }
            catch (Exception ex)
            {
                _swApp.SendMsgToUser($"Error selecting project: {ex.Message}");
                Debug.WriteLine($"PLM Add-In: EXCEPTION in PromptForProjectSelection - {ex.Message}");
                Debug.WriteLine($"PLM Add-In: Stack trace: {ex.StackTrace}");
                return null;
            }
        }

        #region COM Registration

        [ComRegisterFunction]
        public static void RegisterFunction(Type t)
        {
            try
            {
                Microsoft.Win32.RegistryKey hklm = Microsoft.Win32.Registry.LocalMachine;
                Microsoft.Win32.RegistryKey hkcu = Microsoft.Win32.Registry.CurrentUser;

                string keyname = "SOFTWARE\\SolidWorks\\Addins\\{A7E8F9D2-3C4B-5E6A-7F8D-9C0B1A2E3D4F}";
                Microsoft.Win32.RegistryKey addinkey = hklm.CreateSubKey(keyname);
                addinkey.SetValue(null, 0);
                addinkey.SetValue("Description", "PLM Add-In for SolidWorks");
                addinkey.SetValue("Title", "PLM Add-In");

                keyname = "Software\\SolidWorks\\AddInsStartup\\{A7E8F9D2-3C4B-5E6A-7F8D-9C0B1A2E3D4F}";
                addinkey = hkcu.CreateSubKey(keyname);
                addinkey.SetValue(null, 1, Microsoft.Win32.RegistryValueKind.DWord);

                Debug.WriteLine("PLM Add-In: COM registration successful");
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"PLM Add-In: Error during registration - {ex.Message}");
            }
        }

        [ComUnregisterFunction]
        public static void UnregisterFunction(Type t)
        {
            try
            {
                Microsoft.Win32.RegistryKey hklm = Microsoft.Win32.Registry.LocalMachine;
                Microsoft.Win32.RegistryKey hkcu = Microsoft.Win32.Registry.CurrentUser;

                string keyname = "SOFTWARE\\SolidWorks\\Addins\\{A7E8F9D2-3C4B-5E6A-7F8D-9C0B1A2E3D4F}";
                hklm.DeleteSubKey(keyname, false);

                keyname = "Software\\SolidWorks\\AddInsStartup\\{A7E8F9D2-3C4B-5E6A-7F8D-9C0B1A2E3D4F}";
                hkcu.DeleteSubKey(keyname, false);

                Debug.WriteLine("PLM Add-In: COM unregistration successful");
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"PLM Add-In: Error during unregistration - {ex.Message}");
            }
        }

        #endregion
    }
}
